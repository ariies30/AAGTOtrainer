<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Poker Trainer ‚Äì 9-max, TU fisso p1 (a sinistra del mazziere), BTN che ruota</title>
  <style>
    /* History panel (alto-dx) */
.history{
  position:absolute; right:12px; top:40px;
  background:rgba(0,0,0,.35); border:1px solid rgba(255,255,255,.08);
  padding:10px 12px; border-radius:10px;
  width:min(32%, 360px); font-size:12px; line-height:1.35;
  backdrop-filter: blur(6px);
  z-index:999;
  max-height: 42vh;
overflow-y: auto;
}

.history strong{color:#e6f7ff}
.history div+div{margin-top:6px}

/* Action bar (basso-centrale) */
.action-bar{
  position:absolute; left:50%; bottom:6%; transform:translateX(-50%);
  display:flex; gap:10px; flex-wrap:wrap; justify-content:center
}
.action-bar .btn{
  appearance:none; border:1px solid #2a3a58; background:#0f1a2c;
  color:#e8edf3; padding:10px 14px; border-radius:10px; cursor:pointer
}
.action-bar .btn.primary{background:#155e43; border-color:#1a7a58}
.action-bar .btn.warn{background:#5e1525; border-color:#a03b4d}

    :root{
      --bg:#0b0f17; --card:#0f1522; --table:#0b5e3b; --accent:#2fe0a3; --accent-2:#ffd166; --muted:#a0aec0; --text:#e8edf3; --radius:18px; --ring: rgba(47,224,163,.35); --shadow:0 10px 30px rgba(0,0,0,.25); --gap:14px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Inter,Arial,sans-serif; background:radial-gradient(1200px 800px at 50% -10%, #132037 0, var(--bg) 55%); color:var(--text); display:flex; align-items:center; justify-content:center; padding:22px}
    .wrap{width:100%; max-width:1200px}
    .panel{background:linear-gradient(180deg, #121a2b, var(--card)); border:1px solid #1e2a42; border-radius:var(--radius); box-shadow:var(--shadow);}
    .tag{display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; border:1px solid #28486e; font-size:12px; color:#cfe6ff; background:#0b1626}
    button{appearance:none; border:1px solid #24314e; background:#0e1423; color:#e8edf3; padding:12px 14px; border-radius:12px; font-size:15px; cursor:pointer; border-color:#234b3b; background:linear-gradient(180deg,#0f2e28,#0e1f1a); transition:.2s transform ease, .2s box-shadow ease}
    button.primary{background:linear-gradient(180deg,#1a7a58,#11573f); border-color:#1a7a58}
    button:hover{transform:translateY(-1px); box-shadow:0 8px 25px var(--ring)}


.toolbar{
  margin-top: 8px;
  display:flex;
  justify-content:space-between;
  gap:10px;
  align-items:center;
  padding:12px 16px;
}
.toolbar .left, .toolbar .right{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  align-items:center;
}
    .tags-row{
  display:flex;
  gap:8px;
  flex-wrap:wrap;
  margin-top:6px;
}

    /* Table */
    .table-wrap{position:relative; aspect-ratio:16/9; width:100%;}
  .table-oval {
  position: absolute;
  left: 50%;
  top: 50%;
  transform: translate(-50%, -50%);
  width: 78%;               /* leggermente pi√π largo */
  height: 60%;              /* pi√π alto, forma ovale regolare */
  background: radial-gradient(ellipse at center, #0d7c52 0%, #0b5e3b 70%, #084b2f 100%);
  border-radius: 50% / 48%; /* ovale, senza estremit√† tagliate */
  border: 12px solid #2d190a;
  box-shadow: inset 0 0 0 3px #0a3e2a, 0 30px 60px rgba(0,0,0,0.45);
}

    .center-pot{position:absolute; left:50%; top:48%; transform:translate(-50%,-50%); padding:10px 14px; border-radius:12px; background:rgba(0,0,0,.25); border:1px solid rgba(255,255,255,.08); backdrop-filter: blur(6px)}

    /* Mazziere fisso (in basso al centro, fuori dall'ovale) */
    .dealer-person{position:absolute; left:50%; bottom:-6%; transform:translateX(-50%); width:140px}
    .dealer-person .icon{font-size:28px; line-height:1; text-align:center}
    .dealer-person .label{margin-top:6px; text-align:center; font-size:12px; color:var(--muted)}

    /* Chip generiche */
    .chip {position:absolute; width:30px; height:30px; border-radius:50%; display:grid; place-items:center; font-weight:700; box-shadow:0 4px 12px rgba(0,0,0,.35); border:1px solid rgba(0,0,0,.2); color:#111; z-index:5}
    .chip { font-size: 12px; padding: 0 4px; }
    .chip-btn { background:#fff; }
    .chip-sb { background:#9fd4ff; }
    .chip-bb { background:#ff9da0; }

    /* Legacy alias per il BTN (D) */
    .dealer{position:absolute; width:30px; height:30px; border-radius:50%; background:#fff; color:#111; display:grid; place-items:center; font-weight:700; box-shadow:0 4px 12px rgba(0,0,0,.35); z-index:6}

    /* Seats */
    .seat{position:absolute; width:170px; max-width:26vw}
    .seat .box{background:rgba(0,0,0,.42); border:1px solid rgba(255,255,255,.08); border-radius:12px; padding:8px; display:grid; gap:6px}
    .seat .name{display:flex; justify-content:space-between; align-items:center}
    .chips{font-variant-numeric:tabular-nums; color:#e7f7ff}
    .pos-tag{font-size:10px; color:#d1ffe6; border:1px solid rgba(255,255,255,.2); padding:2px 6px; border-radius:999px}
    .cards{display:flex; gap:8px}

    /* Carte (stile scuro precedente) */
    /* Carta ‚Äúvera‚Äù basata su immagine */
/* Carte con angoli vivi (non tagliano le figure) */
.card{
  width:54px;
  height:78px;
  border-radius:4px;           /* o 0 se vuoi totalmente squadrate */
  overflow:visible;            /* evita il taglio dei bordi interni */
  box-shadow:0 2px 6px rgba(0,0,0,.25);
  background:#fff;
  display:flex;
  align-items:center;
  justify-content:center;
}

.card img{
  display:block;
  width:100%;
  height:100%;
  object-fit:contain;          /* mostra l‚Äôintera immagine senza ritagliarla */
  border:none;                 /* niente bordo esterno */
  border-radius:0;             /* niente arrotondamento */
}


    /* Inattivi */
    .inactive .box{opacity:.45; filter:grayscale(80%)}
    .sitout{font-size:11px; color:#ffd5d5; background:rgba(255,92,122,.12); border:1px solid rgba(255,92,122,.35); padding:3px 8px; border-radius:999px}

    /* 9-max: p1 √® in basso SINISTRA, poi orario fino a p9 (basso DESTRA) */
    .p1{left:20%; bottom:2%; transform:translateX(-50%);} /* TU fisso, BL */
    .p2{left:8%; top:66%; transform:translateX(-50%);}    /* Left lower  */
    .p3{left:6%; top:28%; transform:translateX(-50%);}    /* Left upper  */
    .p4{left:20%; top:6%; transform:translateX(-50%);}    /* Upper-left  */
    .p5{left:50%; top:2%;  transform:translateX(-50%);}   /* Top center  */
    .p6{left:80%; top:6%;  transform:translateX(-50%);}   /* Upper-right */
    .p7{left:94%; top:28%; transform:translateX(-50%);}   /* Right upper */
    .p8{left:92%; top:66%; transform:translateX(-50%);}   /* Right lower */
    .p9{left:80%; bottom:2%; transform:translateX(-50%);} /* BR */

    /* Board */
    .board{position:absolute; left:50%; top:28%; transform:translateX(-50%); display:flex; gap:8px}
    .board .card{ width:60px; height:86px }

#table{ padding:22px; position:relative; }

    /* Pulsanti in riga, tag sotto */
.btn-row{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  align-items:center;
}

/* La colonna di sinistra mette i tag sotto i bottoni */
.toolbar .left{
  display:flex;
  flex-direction:column;
  align-items:flex-start;
  gap:8px;
}

/* Evita che la toolbar spinga a destra (non c‚Äô√® pi√π .right) */
.toolbar{
  justify-content:flex-start;
}

.chip {
  position: absolute;
  min-width: 34px;
  height: 34px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 11px;
  line-height: 1;
  font-weight: 700;
  box-shadow: 0 4px 12px rgba(0,0,0,.35);
  border: 1px solid rgba(0,0,0,.2);
  color: #111;
  padding: 0 4px;         /* permette testi come "0.5bb" */
  text-align: center;
  background: #fff;
  z-index: 5;
  transform: translate(-50%, -50%); /* centra la chip sul punto calcolato */
}

.chip-sb { background: #9fd4ff; }
.chip-bb { background: #ff9da0; }
.chip-btn { background: #fff; }


  </style>
</head>
<body>
  <div class="wrap panel" id="table">
<div class="toolbar">
  <div class="left">
    <div class="btn-row">
      <a href="index.html"><button>‚üµ Men√π</button></a>
      <button id="dealBtn" class="primary">Distribuisci mano</button>
      <button id="flipPlayer">Mostra/Nascondi carte "player"</button>
    </div>

    <!-- ‚¨áÔ∏è tag info a SINISTRA, sotto i pulsanti -->
    <div class="tags-row">
      <span class="tag" id="seatInfo">tu: ‚Äî ¬∑ player: ‚Äî</span>
      <span class="tag" id="streetTag">Street: ‚Äî</span>
    </div>
  </div>
</div>

      <div class="history" id="history">
    <div><strong>Preflop:</strong> ‚Äî</div>
  </div>

    <div class="table-wrap">
      <div class="table-oval"></div>
      <div class="center-pot" id="pot">Piatto: 0 bb</div>

      <!-- Mazziere fisso (in basso al centro, fuori dall'ovale) -->
      <div class="dealer-person">
        <div class="icon">üë§</div>
        <div class="label">Mazziere</div>
      </div>

      <!-- Dealer button (dinamico, si muove con il BTN) -->
      <div class="dealer chip chip-btn" id="btn">D</div>
      <!-- Blinds dinamiche -->
      <div class="chip chip-sb" id="sb">SB</div>
      <div class="chip chip-bb" id="bb">BB</div>

      <!-- Board cards -->
      <div class="board" id="board"></div>
      <!-- History panel -->


<!-- Action bar -->
<div class="action-bar" id="actions"></div>
      <!-- ===== 9 SEATS ===== -->
      <div class="seat p1" id="seat1"><div class="box"><div class="name"><strong class="label-name">Seat 1</strong><span class="pos-tag">‚Äî</span></div><div class="cards"><div class="card face-down">üÇ†</div><div class="card face-down">üÇ†</div></div><div class="chips">‚Äî</div></div></div>
      <div class="seat p2" id="seat2"><div class="box"><div class="name"><strong class="label-name">Seat 2</strong><span class="pos-tag">‚Äî</span></div><div class="cards"><div class="card face-down">üÇ†</div><div class="card face-down">üÇ†</div></div><div class="chips">‚Äî</div></div></div>
      <div class="seat p3" id="seat3"><div class="box"><div class="name"><strong class="label-name">Seat 3</strong><span class="pos-tag">‚Äî</span></div><div class="cards"><div class="card face-down">üÇ†</div><div class="card face-down">üÇ†</div></div><div class="chips">‚Äî</div></div></div>
      <div class="seat p4" id="seat4"><div class="box"><div class="name"><strong class="label-name">Seat 4</strong><span class="pos-tag">‚Äî</span></div><div class="cards"><div class="card face-down">üÇ†</div><div class="card face-down">üÇ†</div></div><div class="chips">‚Äî</div></div></div>
      <div class="seat p5" id="seat5"><div class="box"><div class="name"><strong class="label-name">Seat 5</strong><span class="pos-tag">‚Äî</span></div><div class="cards"><div class="card face-down">üÇ†</div><div class="card face-down">üÇ†</div></div><div class="chips">‚Äî</div></div></div>
      <div class="seat p6" id="seat6"><div class="box"><div class="name"><strong class="label-name">Seat 6</strong><span class="pos-tag">‚Äî</span></div><div class="cards"><div class="card face-down">üÇ†</div><div class="card face-down">üÇ†</div></div><div class="chips">‚Äî</div></div></div>
      <div class="seat p7" id="seat7"><div class="box"><div class="name"><strong class="label-name">Seat 7</strong><span class="pos-tag">‚Äî</span></div><div class="cards"><div class="card face-down">üÇ†</div><div class="card face-down">üÇ†</div></div><div class="chips">‚Äî</div></div></div>
      <div class="seat p8" id="seat8"><div class="box"><div class="name"><strong class="label-name">Seat 8</strong><span class="pos-tag">‚Äî</span></div><div class="cards"><div class="card face-down">üÇ†</div><div class="card face-down">üÇ†</div></div><div class="chips">‚Äî</div></div></div>
      <div class="seat p9" id="seat9"><div class="box"><div class="name"><strong class="label-name">Seat 9</strong><span class="pos-tag">‚Äî</span></div><div class="cards"><div class="card face-down">üÇ†</div><div class="card face-down">üÇ†</div></div><div class="chips">‚Äî</div></div></div>
    </div>
  </div>

  <script>
    // Base path degli asset (SVG o PNG)
const CARD_BASE = "assets/cards";
const CARD_EXT  = "svg"; // se usi png metti "png"

// mappa per nomi seme e rank
const SUIT_NAME = { "‚ô£":"clubs", "‚ô¶":"diamonds", "‚ô•":"hearts", "‚ô†":"spades" };
function RANK_NAME(r){ return r === "T" ? "10" : r; }

// costruisce il path dell‚Äôimmagine
function cardSrc(rank, suit){
  return `${CARD_BASE}/${RANK_NAME(rank)}_of_${SUIT_NAME[suit]}.${CARD_EXT}`;
}
const CARD_BACK = `${CARD_BASE}/back.${CARD_EXT}`;

    const $ = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));

    const RANKS = ['2','3','4','5','6','7','8','9','T','J','Q','K','A'];
    const SUITS = ['‚ô£','‚ô¶','‚ô•','‚ô†'];

    function buildDeck(){ const d=[]; for(const r of RANKS){ for(const s of SUITS){ d.push(r+s); } } return d; }
    function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; }
    // Carta a faccia in su (usa l‚Äôimmagine rank+suit)
function cardEl(txt){
  const rank = txt[0];      // '2'..'9','T','J','Q','K','A'
  const suit = txt[1];      // '‚ô£','‚ô¶','‚ô•','‚ô†'
  const wrap = document.createElement('div');
  wrap.className = 'card';
  const img = document.createElement('img');
  img.alt = `${RANK_NAME(rank)} of ${SUIT_NAME[suit]}`;
  img.src = cardSrc(rank, suit);
  wrap.appendChild(img);
  return wrap;
}

// Carta coperta (dorso)
function faceDownEl(){
  const wrap = document.createElement('div');
  wrap.className = 'card face-down';
  const img = document.createElement('img');
  img.alt = 'Card back';
  img.src = CARD_BACK;
  wrap.appendChild(img);
  return wrap;
}


const CHIP_OVAL = {
  cx: 50,
  cy: 52,
  rx: 33,   // üîΩ raggio orizzontale ridotto ‚Üí pi√π interno
  ry: 24    // üîΩ raggio verticale ridotto ‚Üí pi√π vicino al centro
};



// Angoli (in gradi) per i 9 seat orientati come sul tavolo (in senso orario)
// 90¬∞ = top, 0¬∞ = destra, 180¬∞ = sinistra, 270¬∞/‚àí90¬∞ = bottom
const SEAT_ANGLE = {
  1: 220,  // p1  bottom-left
  2: 200,  // p2  left-lower
  3: 150,  // p3  left-upper
  4: 120,  // p4  upper-left
  5:  90,  // p5  top center
  6:  60,  // p6  upper-right
  7:  30,  // p7  right-upper
  8: 340,  // p8  right-lower
  9: 320   // p9  bottom-right
};

// Converte un angolo (¬∞) in coordinate % su ellisse centrata
function ovalPos(angleDeg){
  const t = angleDeg * Math.PI / 180;
  const x = CHIP_OVAL.cx + CHIP_OVAL.rx * Math.cos(t);
  const y = CHIP_OVAL.cy + CHIP_OVAL.ry * Math.sin(t);
  return { left: x.toFixed(2) + '%', top: y.toFixed(2) + '%' };
}


    // Riferimenti ai 9 seat
    const seats = $$('.seat').map((el,idx)=>({
      idx: idx+1,
      el,
      nameEl: el.querySelector('.label-name'),
      posEl: el.querySelector('.pos-tag'),
      cardsEl: el.querySelector('.cards'),
      chipsEl: el.querySelector('.chips')
    }));

    const btnEl = $('#btn');
    const sbEl = $('#sb');
    const bbEl = $('#bb');
    const boardEl = $('#board');
    const potEl = $('#pot');
    const seatInfoEl = $('#seatInfo');
    const streetTagEl = document.getElementById('streetTag');
const historyEl   = document.getElementById('history');
const actionsEl   = document.getElementById('actions');

// Stato per street & history
const STREETS = ['preflop'];
let street = 'preflop';
let history = { preflop: [] };
let toAct = 'tu'; // 'tu' | 'player'
let pot = 0; // piatto in bb



    // Stato corrente
    const TU_FIXED_SEAT = 1; // TU √® sempre p1 (alla sinistra del mazziere)
    let tuSeat = TU_FIXED_SEAT;
    let playerSeat = null;   // indice seat 2..9
    let btnSeat = 1 + Math.floor(Math.random()*9); // BTN di partenza casuale

    let tuCards = [];
    let playerCards = [];
    let theBoard = [];

    let tuFaceUp = true;
    let playerFaceUp = false;

    function pickOpponentSeat(){
      const pool = [2,3,4,5,6,7,8,9];
      return pool[Math.floor(Math.random()*pool.length)];
    }

function resetSeats(){
  seats.forEach(s=>{
    s.el.classList.add('inactive');
    s.nameEl.textContent = `Seat ${s.idx}`;
    // niente carte visibili per i sit-out
    s.cardsEl.innerHTML = '';
    s.chipsEl.textContent = '‚Äî';
    // aggiungi badge ‚ÄúSit out‚Äù se non esiste gi√†
    if(!s.el.querySelector('.sitout')){
      const badge = document.createElement('span');
      badge.className='sitout';
      badge.textContent='Sit out';
      s.el.querySelector('.name').appendChild(badge);
    }
  });
}

    function setActive(iTu, iPl){
      resetSeats();
      tuSeat = iTu; playerSeat = iPl;
      [iTu, iPl].forEach(i=>{
        const s = seats[i-1];
        s.el.classList.remove('inactive');
        const badge = s.el.querySelector('.sitout');
        if(badge) badge.remove();
        s.chipsEl.textContent = 'Stack: 100 bb';
      });
      seats[iTu-1].nameEl.textContent = 'tu';
      seats[iPl-1].nameEl.textContent = 'player';
    }

function assignPositions(){
  // Ordine richiesto in senso orario
  const order = ['BTN','SB','BB','UTG','+1','LJ','HJ','MP','CO'];
  // assegna partendo dal BTN e proseguendo seat per seat in orario
  for (let i = 0; i < 9; i++) {
    const seatIdx0 = ((btnSeat - 1) + i) % 9;  // indice 0..8 del seat fisico
    seats[seatIdx0].posEl.textContent = order[i];
  }
}


function placeRoleChips(){
  // Legge i ruoli reali scritti da assignPositions()
  const btnIdx = seatIndexByPosTag('BTN');
  const sbIdx  = seatIndexByPosTag('SB');
  const bbIdx  = seatIndexByPosTag('BB');

  // BTN -> D
  if (btnIdx && SEAT_ANGLE[btnIdx] !== undefined){
    const p = ovalPos(SEAT_ANGLE[btnIdx]);
    btnEl.style.left = p.left;
    btnEl.style.top  = p.top;
    btnEl.textContent = 'D';
    btnEl.title = 'Button';
  }

  // SB -> 0.5bb
  if (sbIdx && SEAT_ANGLE[sbIdx] !== undefined){
    const p = ovalPos(SEAT_ANGLE[sbIdx]);
    sbEl.style.left = p.left;
    sbEl.style.top  = p.top;
    sbEl.textContent = '0.5bb';
    sbEl.title = 'Small Blind: 0.5bb';
  }

  // BB -> 1bb
  if (bbIdx && SEAT_ANGLE[bbIdx] !== undefined){
    const p = ovalPos(SEAT_ANGLE[bbIdx]);
    bbEl.style.left = p.left;
    bbEl.style.top  = p.top;
    bbEl.textContent = '1bb';
    bbEl.title = 'Big Blind: 1bb';
  }
}






    // ===== ORDINE DI AZIONE =====
// Ordine completo 9-max in senso orario a partire da BTN:
const PREFLOP_ORDER  = ['UTG','+1','LJ','HJ','MP','CO','BTN','SB','BB']; // preflop inizia UTG

function positionOf(who){
  const seatIdx = (who === 'tu' ? tuSeat : playerSeat) - 1;
  return seats[seatIdx].posEl.textContent; // es. 'BTN','SB','BB','UTG','+1','LJ','HJ','MP','CO'
}
    
function seatIndexByPosTag(tag){
  const s = seats.find(seat => seat.posEl.textContent === tag);
  return s ? s.idx : null; // 1..9 oppure null
}

function seatIndexByPosTag(tag){
  const s = seats.find(seat => seat.posEl.textContent === tag);
  return s ? s.idx : null; // 1..9, oppure null se non trovato
}

// Ritorna 'tu' o 'player' a seconda di chi viene prima nell'ordine della street
function firstActorForStreet(){
  const tuPos = positionOf('tu');
  const plPos = positionOf('player');
  const order = PREFLOP_ORDER; // sempre preflop

  const ai = order.indexOf(tuPos);
  const bi = order.indexOf(plPos);
  if (ai === -1 || bi === -1) return 'tu';
  return (ai < bi) ? 'tu' : 'player';
}



function newHand(){
  // Ruota BTN in senso orario
  btnSeat = (btnSeat % 9) + 1;

  // Assegna posizioni
  assignPositions();
  placeRoleChips();


  // Scegli avversario tra 2..9
  const opp = pickOpponentSeat();
  setActive(TU_FIXED_SEAT, opp);

  // Carte
  const deck = shuffle(buildDeck());
  tuCards = [deck.pop(), deck.pop()];
  playerCards = [deck.pop(), deck.pop()];
  theBoard = [deck.pop(), deck.pop(), deck.pop(), deck.pop(), deck.pop()];

// Solo preflop
street = 'preflop';
buildHistoryUpTo(street);
streetTagEl.textContent = 'Street: PREFLOP';


  // UI
  renderHands();
  renderBoard();
pot = 1.5; // 0.5 + 1
potEl.textContent = `Piatto: ${pot} bb`;


  // Info
  const tuPos = seats[tuSeat-1].posEl.textContent;
  const plPos = seats[playerSeat-1].posEl.textContent;
  seatInfoEl.textContent = `tu: ${tuPos} ¬∑ player: ${plPos}`;
  streetTagEl.textContent = `Street: ${street.toUpperCase()}`;
  renderHistoryPanel();
  renderActions();
}


function renderHands(){
  seats.forEach((s, idx) => {
    const i = idx + 1;
    if (i === tuSeat) {
      s.cardsEl.innerHTML = '';
      if (tuFaceUp) {
        tuCards.forEach(c => s.cardsEl.appendChild(cardEl(c)));
      } else {
        s.cardsEl.appendChild(faceDownEl());
        s.cardsEl.appendChild(faceDownEl());
      }
    } else if (i === playerSeat) {
      s.cardsEl.innerHTML = '';
      if (playerFaceUp) {
        playerCards.forEach(c => s.cardsEl.appendChild(cardEl(c)));
      } else {
        s.cardsEl.appendChild(faceDownEl());
        s.cardsEl.appendChild(faceDownEl());
      }
    } else {
      // SEAT INATTIVO: niente elementi .card, spazio completamente vuoto
      s.cardsEl.innerHTML = '';
    }
  });
}


function renderBoard(){ boardEl.innerHTML=''; }

function appendAction(st, who, type, size=''){
  history[st].push({who,type,size});
}

function randomPreflop(){
  const actor = firstActorForStreet('preflop');            // chi deve parlare per primo (UTG-side)
  const opp   = (actor === 'tu') ? 'player' : 'tu';
  toAct = actor;

  const r = Math.random();
  // esempi plausibili e simmetrici, rispettando chi inizia:
  if (r < 0.33){
    appendAction('preflop', actor, 'raise', '3bb');
    appendAction('preflop', opp,   'call');
    toAct = actor; // dopo il call, azione torna all'aggressore per semplicit√† nello spot corrente
  } else if (r < 0.66){
    appendAction('preflop', actor, 'limp');
    appendAction('preflop', opp,   'check');
    toAct = actor;
  } else {
    appendAction('preflop', actor, 'raise', '2.5bb');
    appendAction('preflop', opp,   Math.random()<0.5 ? 'fold' : 'call');
    toAct = actor;
  }
}

function buildHistoryUpTo(){
  history = { preflop: [] };
  toAct = firstActorForStreet('preflop'); // parte UTG-side
}



function renderHistoryPanel(){
  const fmt = (arr)=> arr && arr.length
    ? arr.map(a=>`${a.who}: ${a.type}${a.size?` ${a.size}`:''}`).join(' ¬∑ ')
    : '‚Äî';
  historyEl.innerHTML = `<div><strong>Preflop:</strong> ${fmt(history.preflop)}</div>`;
}


function lastAggressorOnStreet(st){
  const arr = history[st] || [];
  for (let i = arr.length - 1; i >= 0; i--){
    if (arr[i].type === 'bet' || arr[i].type === 'raise') return arr[i].who;
  }
  return null;
}



    
    // === Street helpers ===
function lastAction(st){
  const arr = history[st];
  return arr.length ? arr[arr.length-1] : null;
}
function raisesOnStreet(st){
  // conta solo 'raise' (il primo 'bet' non √® raise)
  return history[st].filter(a => a.type === 'raise').length;
}

function lastIsCallClosing(st){
  // heads-up: se c'√® stata una bet/raise e l'altro fa 'call', la street √® chiusa
  const arr = history[st];
  if (arr.length < 1) return false;
  const last = arr[arr.length-1];
  if (last.type !== 'call') return false;
  const aggressor = lastAggressorOnStreet(st);
  // chiude se il call √® dell'altro rispetto all'ultimo aggressore
  return aggressor && last.who !== aggressor;
}
    
function endOfStreetReached(){
  // Preflop si chiude su:
  // - call che chiude l'ultima aggressione
  // - sequenza limp -> check
  const arr = history.preflop;
  if (!arr.length) return false;

  // call che chiude
  if (lastIsCallClosing('preflop')) return true;

  // limp -> check
  const len = arr.length;
  if (len >= 2 && arr[len-2].type === 'limp' && arr[len-1].type === 'check') return true;

  return false;
}

function advanceStreet(){
  // in preflop-only, "avanzare" significa chiudere il training della mano
  actionsEl.innerHTML = '<span class="tag">Preflop completo</span>';
}

function maybeAdvanceStreet(){
  if (endOfStreetReached()){
    advanceStreet();
    return true;
  }
  return false;
}


// Etichetta "3-bet/4-bet/5-bet" in base al numero di raises gi√† avvenuti
function nextReRaiseLabel(){
  const rc = raisesOnStreet(street); // 0 dopo una semplice bet
  if (rc === 0) return 'Raise (3-bet)';
  if (rc === 1) return 'Raise (4-bet)';
  if (rc === 2) return 'Raise (5-bet)';
  return 'Raise'; // oltre 5-bet: fallback
}
// Limite: consenti fino alla 5-bet (cio√® max 3 re-raise oltre il primo raise)
function canReRaise(){
  return raisesOnStreet(street) < 3;
}


function addBtn(text, cls, onClick){
  const b = document.createElement('button');
  b.className = 'btn'+(cls?` ${cls}`:'');
  b.textContent = text;
  b.addEventListener('click', onClick);
  actionsEl.appendChild(b);
}

function renderActions(){
  actionsEl.innerHTML = '';
  const actor = toAct; // 'tu' | 'player'
  const aggressor = lastAggressorOnStreet('preflop');
  const facingRaise = !!(aggressor && aggressor !== actor); // sto subendo open/3bet/4bet...
  const raises = history.preflop.filter(a=>a.type==='raise').length;

  function endHand(msg='Preflop completo'){
    actionsEl.innerHTML = `<span class="tag">${msg}</span>`;
  }

  function addBtn(text, cls, onClick){
    const b = document.createElement('button');
    b.className = 'btn'+(cls?` ${cls}`:'');
    b.textContent = text;
    b.addEventListener('click', onClick);
    actionsEl.appendChild(b);
  }

  function doAndNext(who, type, size){
    appendAction('preflop', who, type, size);
    renderHistoryPanel();

    if (type === 'fold'){ endHand('Mano terminata (fold preflop)'); return; }
    if (maybeAdvanceStreet()) return;

    toAct = (who === 'tu') ? 'player' : 'tu';
    renderActions();
  }

  // === TURNO DI "tu" ===
  if (actor === 'tu'){
    if (!facingRaise){
      // Apertura spot: Fold / Limp / Open
      addBtn('Fold', 'warn', ()=> doAndNext('tu','fold'));
      addBtn('Limp', '',      ()=> doAndNext('tu','limp'));
      addBtn('Open 2.5bb', 'primary', ()=> doAndNext('tu','raise','2.5bb'));
    } else {
      // Sto affrontando open/3bet/4bet...
      addBtn('Call', 'primary', ()=> doAndNext('tu','call'));
      addBtn('Fold', 'warn',    ()=> doAndNext('tu','fold'));
      if (raises === 1) addBtn('3-bet', '', ()=> doAndNext('tu','raise','3x'));
      if (raises === 2) addBtn('4-bet', '', ()=> doAndNext('tu','raise','2x'));
      if (raises === 3) addBtn('5-bet', '', ()=> doAndNext('tu','raise','2x'));
    }
    return;
  }

  // === TURNO DEL "player" (AI minimale coerente) ===
  const r = Math.random();
  if (!facingRaise){
    if (r < 0.25) doAndNext('player','fold');
    else if (r < 0.45) doAndNext('player','limp');
    else doAndNext('player','raise','2.5bb'); // open
  } else {
    if (raises === 1){ // facing open
      if (r < 0.55) doAndNext('player','call');
      else if (r < 0.80) doAndNext('player','raise','3x'); // 3-bet
      else doAndNext('player','fold');
    } else if (raises === 2){ // facing 3-bet
      if (r < 0.55) doAndNext('player','call');
      else if (r < 0.75) doAndNext('player','raise','2x'); // 4-bet
      else doAndNext('player','fold');
    } else if (raises === 3){ // facing 4-bet
      if (r < 0.55) doAndNext('player','call');            // chiude preflop
      else if (r < 0.70) doAndNext('player','raise','2x'); // 5-bet
      else doAndNext('player','fold');
    } else {
      doAndNext('player','call'); // sicurezza
    }
  }
}





    // Handlers UI
    document.getElementById('dealBtn').addEventListener('click', newHand);
    document.getElementById('flipPlayer').addEventListener('click', ()=>{ playerFaceUp = !playerFaceUp; renderHands(); });

    // Avvio
newHand();


  </script>
</body>
</html>
